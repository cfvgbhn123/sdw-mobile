/**
 * Created by CHEN-BAO-DENG on 2017/3/20.
 *
 * 游戏部分功能初始化
 *
 * 1.游客模式的检查
 * 2.闪电玩分享对象
 *
 */

// 对下架的游戏做跳转处理
(function(){var k={1397969747:"http://cdn.app.m3guo.com/html/201710/59ef016b275a4.html"};k[SDW_WEB.MOBILE_GAME_GID]&&(location.href=k[SDW_WEB.MOBILE_GAME_GID])})();var HTTP_AUTH=HTTP_USER_STATIC+"authgame",_protocol_=location.protocol;(function(){function k(c){var a=document.querySelector("#my-game-container");a&&a.contentWindow.postMessage(JSON.stringify(c),"*")}function n(c){document.title=c.name;$(".sIcon").attr("href",c.sIcon);$(".sTitle").attr("content",c.name);$("#setShareImg").attr("src",c.sIcon);$(".sDesc").attr("content",c.sDes)}function p(c){if(c.param){var a="true"==SDW_WEB.queryParam.sdw_test?c.testUrl||c.url:c.url;SDW_WEB.MICRO_REVIEW&&SDW_WEB.MICRO_REVIEW_LINK&&(a=SDW_WEB.MICRO_REVIEW_LINK);var a=-1===a.indexOf("?")?a+("?"+c.param):a+("\x26"+c.param),b=SDW_WEB.onWyqq?"http://www.shandw.com/wyqq/game/"+SDW_WEB.MOBILE_GAME_GID+".html?channel\x3d"+SDW_WEB.channel:SDW_PATH.GAME_URL("play",SDW_WEB.MOBILE_GAME_GID);SDW_WEB.queryParam.url_Type&&(a+="\x26url_Type\x3d"+SDW_WEB.queryParam.url_Type,b+="\x26url_Type\x3d"+SDW_WEB.queryParam.url_Type);SDW_WEB.MICRO_REVIEW&&(a+="\x26app_review\x3d1");b=encodeURIComponent(b);a=a+("\x26cburl\x3d"+b)+("\x26reurl\x3d"+b);SDW_WEB.USER_INFO.fl&&(a+="\x26fl\x3d"+SDW_WEB.USER_INFO.fl);SDW_WEB.queryParam.gmUnitId&&(a+="\x26gmUnitId\x3d"+SDW_WEB.queryParam.gmUnitId);SDW_WEB.queryParam.recordId&&(a+="\x26recordId\x3d"+SDW_WEB.queryParam.recordId);SDW_WEB.queryParam.gmType&&(a+="\x26gmType\x3d"+SDW_WEB.queryParam.gmType);var b=c.gid,d,e=SDW_WEB.URLS.queryUrl(!0,a),f={},g=SDW_WEB.queryParam;for(d in g)"gid"!=d&&"channel"!=d&&"_sender_sdw_rfid_"!=d&&"v"!=d&&(e[d]?console.log("\u53c2\u6570\u3010"+d+"\u3011\u51b2\u7a81"):f[d]=g[d]);d=(d=SDW_WEB.URLS.param(f,!0))?"\x26"+d:"";a+=d;/^https:\/\//.test(a)||"http:"===_protocol_||(e=visitorMode.isVisitor?"\x26isVisitor\x3d1":"",SDW_WEB.onShandw?location.href=location.href.replace(/https:\/\//,"http://"):(window.FIRST_TRANS=!0,d="http://www.shandw.com/libs/addUserInfo2.html?channel\x3d"+SDW_WEB.channel+"\x26userInfo\x3d"+encodeURIComponent(JSON.stringify(SDW_WEB.USER_INFO))+"\x26gid\x3d"+b+e+"\x26storeType\x3d"+window.DATAITEM+d,location.href=d));SDW_WEB._atSDW=c.atSDW;SDW_WEB._BDDSWTOKEN=c.BDDSWTOKEN;SDW_WEB._qrcode=c.qrcode;SDW_WEB.useweb&&(a+="\x26sdw_useweb\x3d1");SDW_WEB.onWyqq&&(a+="\x26wyqq\x3d1");w(a)}else alert("[Error]: \u7f3a\u5c11\u6e38\u620f\u53c2\u6570\u5b57\u6bb5param")}function w(c){var a=document.querySelector("#my-game-container");if(a)a.src=c;else{a=document.createElement("iframe");a.id="my-game-container";a.className="my-game-container my-game-opacity";a.name="my-game-container";a.src=c;a.frameborder="0";a.style.frameborder="0";a.style.border="none";a.style.boxShadow="none";$("#g-container").append(a).css({height:(document.documentElement.clientHeight||document.body.clientHeight)+"px",display:"block"});SDW_WEB.MOBILR_GAME_URL_IFRM=c+"\x26REFRESH_TAG";var b=setTimeout(function(){dialog.show("loading","\u6e38\u620f\u53ef\u80fd\u52a0\u8f7d\u8fc7\u6162\uff0c\u8bf7\u8010\u5fc3\u7a0d\u7b49....",1)},1E4);a.onload=function(){window._calPageHeight&&window._calPageHeight();x();b&&clearTimeout(b)}}var d=null,e=function(){d&&clearTimeout(d);d=setTimeout(function(){var c=document.documentElement.clientWidth||document.body.clientWidth,b=document.documentElement.clientHeight||document.body.clientHeight;a&&(a.style.height=b+"px",a.style.width=c+"px",a.width=c+"px",a.height=b+"px",a.contentWindow.postMessage(JSON.stringify({postSdwData:!0,operate:"window_size_change",width:c,height:b}),"*"));window.touch&&window.touch.update();window._calPageHeight&&window._calPageHeight()},400)};window.onresize=function(){e()};window.onorientationchange=function(){switch(window.orientation){case 0:e();break;case -90:e();break;case 90:e()}}}function x(){SDW_WEB.setLoadText.setText("loaded");var c=+new Date-loadPageTime;setTimeout(function(){$(".loading-container").addClass("loading-hidden");$(".my-game-opacity").removeClass("my-game-opacity")},(300<c?0:300-c)+200);document.body.style.background="#333";SDW_WEB.playGameTimer.start(SDW_WEB.MOBILE_GAME_GID)}SDW_WEB.onAndriod&&(window.onDHSDKResult=function(){k({postSdwData:!0,operate:"DH_WAP_PAY_CALLBACK"})});SDW_WEB.share_success_callback=function(){dialog.show("ok","\u60a8\u5df2\u7ecf\u5206\u4eab\u6210\u529f",1);var c=SDW_WEB.getNow();SDW_WEB.Store.set("_SDW_SHARE_TIME_"+SDW_WEB.USER_INFO.uid,c,!0);localStorage["_SDW_SHARE_TIME_"+SDW_WEB.USER_INFO.uid]=""+c;c="day_game_list"+SDW_WEB.USER_INFO.uid;if(SDW_WEB.MOBILE_GAME_GID){var a=SDW_WEB.Store.get(c,!0),b=new Date;if(a){var d=new Date(a.time);a.list=a.list||[];var e=b.getFullYear(),f=b.getMonth()+1,g=b.getDate(),l=d.getFullYear(),m=d.getMonth()+1,d=d.getDate();if(e!==l||f!==m||g!==d)a.list=[]}else a={list:[]};a.time=+b;a.list.push(SDW_WEB.MOBILE_GAME_GID);SDW_WEB.Store.set(c,a,!0)}};SDW_WEB.changeShareLinks=function(c){c||(c=SDW_WEB.onWyqq?"http://www.shandw.com/wyqq/game/"+SDW_WEB.MOBILE_GAME_GID+".html?channel\x3d"+SDW_WEB.channel:SDW_PATH.GAME_URL("play",SDW_WEB.MOBILE_GAME_GID));var a=c;!/_sender_sdw_rfid_/.test(c)&&SDW_WEB.USER_INFO.uid&&(a=SDW_WEB.URLS.addParam({_sender_sdw_rfid_:SDW_WEB.USER_INFO.uid},!0,c));return a};window.visitorMode={isVisitor:!0,visitorToken:"",authGame:function(c,a){var b=SDW_WEB.MOBILE_GAME_GID,d=this;if(b){var e=SDW_WEB.channel,f=+new Date,g=SDW_WEB.MD5(""+e+b+SDW_WEB.guid+f+"0ef7a6ba9d8d288fbeca1cdebf13c03e"),b={channel:e,token:g,gid:b,sec:f,loginType:0},b="undefined"!==typeof a?SDW_WEB.URLS.addParam(b,!1,HTTP_USER_STATIC+"divauth"):SDW_WEB.URLS.addParam(b,!1,HTTP_USER_STATIC+"vstgame");SDW_WEB.getAjaxData(b,function(b){1==b.result?(SDW_WEB.setLoadText.setText("auth"),"undefined"!==typeof a&&(SDW_WEB.USER_INFO=SDW_WEB.USER_INFO||{},SDW_WEB.USER_INFO.uid=b.uid),n(b),window.visitorIconSrc=b.sIcon,d.visitorToken=b.vstToken,visitorMode._visitorToken=b.vstToken,p(b),c&&c(b.sIcon),SDW_WEB.sdw.onSetShareOperate({title:b.sTit,desc:b.sDes,link:SDW_WEB.changeShareLinks(),imgUrl:SDW_WEB._sIcon,success:function(){SDW_WEB.share_success_callback()},cancel:function(){}})):alert(b.msg)})}else alert("\u7f3a\u5c11\u6e38\u620fid")}};window.addEventListener("message",function(c){if("string"===typeof c.data)try{var a=JSON.parse(c.data);if(a.postElloData)_myFuchuang.fchiddenFn(0),_myFuchuang.tabNav(window.moreGame,window.moreGame.$index),SDW_WEB.onIOS&&$("#my-game-container").addClass("my-game-container-ani");else if(a.postSdwData)if("DH_WAP_PAY_CALLBACK"==a.operate){var b=window.NativeBridge.callbacksCount++,d=function(){c.source.postMessage(JSON.stringify({postSdwData:!0,operate:"DH_WAP_PAY_CALLBACK"}),"*")},e=JSON.stringify({callbackId:b,args:JSON.stringify(a.args)});window.NativeBridge.callbacks[b]=d;var f="tongjunling://wapPayment#"+e,g=document.createElement("IFRAME");g.src=f;document.documentElement.appendChild(g);g.parentNode.removeChild(g);g=null}else if("requestFullScreen"===a.operate)h.requestFullScreen();else if("exitFullScreen"===a.operate)h.exitFullScreen();else if("sdw_addDesktop"===a.operate)r({},!1);else if("createNativeBridgeCallback"==a.operate){var l=JSON.parse(a.optionStr),d=function(b){c.source.postMessage(JSON.stringify({postSdwData:!0,fncName:a.fncName,callbackId:a.callbackId,res:b,operate:"createNativeBridgeCallback_callback"}),"*")};window.NativeBridge.callbacks[a.callbackId]=d;e=JSON.stringify({callbackId:a.callbackId,args:a.args});f="";"quickPayment"===a.fncName||"ApplePayment"===a.fncName?f="payment://":SDW_WEB.onShandw?f="sdw://":SDW_WEB.onKD&&(f="kd://");f+=a.fncName+"#"+e;g=document.createElement("IFRAME");g.src=f;document.documentElement.appendChild(g);g.parentNode.removeChild(g);g=null}else if("callquickPayment_Android"==a.operate)l=JSON.parse(a.optionStr),l.complete=l.complete&&eval("("+l.complete+")"),d=top.NativeBridge.createSDKCallback(l),CDLAndroid.quickPayment(JSON.stringify(l)),top.onDHSDKResult=d;else if("setSDWShareInfo"===a.operate)h.setSDWShareInfo(c,a);else if("checkVisitorMode"===a.operate)h.checkVisitorMode(c,a);else if("sdw_setLocalStorage"===a.operate)h.sdw_setLocalStorage(c,a);else if("sdw_getLocalStorage"===a.operate)h.sdw_getLocalStorage(c,a);else if("to_competition"===a.operate)h.to_competition(c,a);else if("sdw_postGameInfo"===a.operate)h.sdw_postGameInfo(c,a);else if("openUrlToRoot"===a.operate)h.openUrlToRoot(c,a.option);else if("sendMsg"===a.operate){var m=a.data.iconClass,y=a.data.message,k=a.data.duration||0;"fail"===m&&(m="error");"success"===m&&(m="ok");dialog.show(m||"ok",y);dialog.hidden(k)}else{var n=h[a.operate];n&&n(c,a)}else if(a.wxappId&&a.wxpaySign)WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:a.wxappId,timeStamp:a.wxtimeStamp,nonceStr:a.wxnonceStr,"package":a.wxpackage,signType:a.wxsignType,paySign:a.wxpaySign},function(a){});else if("requestOpenAPP_wxPay"===a.operate){var q=a.resultInfo;if(q){var p=SDW_WEB.URLS.addParam({go:q},!0,"http://www.shandw.com/libs/weixin.html");SDW_WEB.onAndriod&&window.Android&&window.Android.openURL?window.Android.openURL(p):SDW_WEB.onIOS&&window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.openURL&&window.webkit.messageHandlers.openURL.postMessage?window.webkit.messageHandlers.openURL.postMessage(p):location.href=q}}else if("requestOpenAPP_alipayPay"===a.operate){if(a.resultInfo){document.querySelector("#alipay_form").innerHTML=a.resultInfo;for(var t=document.querySelectorAll("#alipaysubmit\x3einput"),b={},d=0;d<t.length;d++){var u=t[d];b[u.name]=u.value}var v=SDW_WEB.URLS.addParam(b,!0,"http://www.shandw.com/libs/aliPay.html");SDW_WEB.onAndriod&&window.Android&&window.Android.openURL?window.Android.openURL(v):SDW_WEB.onIOS&&window.webkit&&window.webkit.messageHandlers&&window.webkit.messageHandlers.openURL&&window.webkit.messageHandlers.openURL.postMessage?window.webkit.messageHandlers.openURL.postMessage(v):document.querySelector("#alipaysubmit").submit()}}else"requestShowQrcode"===a.operate?showPayModelMask(a.codeUrl):"requestHideQrcode"===a.operate&&hidePayModelMask()}catch(z){}},!1);SDW_WEB.onWyqq&&window.addEventListener("message",function(c){if(c.source===window.parent&&0<=c.origin.indexOf("open.game.163.com")&&(c=JSON.parse(c.data),"WebviewNCGObject.shareCallBack"===c.messageType))if(200===c.code)dialog.show("ok","\u5206\u4eab\u6210\u529f",1),k({postSdwData:!0,oprate:"shareCallback_success"});else if(206===c.code||400===c.code)dialog.show("error","\u5206\u4eab\u53d6\u6d88",1),k({postSdwData:!0,oprate:"shareCallback_cancel"})},!1);var h={logMsg:"",sdw_getGameToken:function(c,a){var b=a.data,b={miniProId:b.gid,uid:b.uid,time:+new Date};b.sign=SDW_WEB.MD5(""+b.miniProId+b.uid+b.time+"1fb964b3f62d471080fd7e465646379e");SDW_WEB.postAjaxData("https://sttc.shandw.com/getUploadSecret",b,function(a){c.source.postMessage(JSON.stringify({postSdwData:!0,data:a,operate:"getGameToken_callback"}),"*")})},sdw_goBackstage:function(c,a){SDW_WEB.sdw.goBackstage(function(){c.source.postMessage(JSON.stringify({postSdwData:!0,operate:"goBackstage_callback"}),"*")})},sdw_recoverBackstage:function(c,a){SDW_WEB.sdw.recoverBackstage(function(){c.source.postMessage(JSON.stringify({postSdwData:!0,operate:"recoverBackstage_callback"}),"*")})},sdw_setGameToolPositionY:function(c,a){var b=a.y;window.touch?window.touch.setPositionY(b):window.touch_initY=b},postChoosePayInfo:function(c,a){SDW_WEB.sdw.postChoosePayInfo(a.data)},postPaySuccessInfo:function(c,a){SDW_WEB.sdw.postPaySuccessInfo(a.data)},postGamePlayerInfo:function(c,a){SDW_WEB.sdw.postGamePlayerInfo(a.data)},changeEggStatus:function(){_myFuchuang&&_myFuchuang.loadActivityToolInfo()},changeSDCoin:function(c,a){_myFuchuang.myGold+=a.data.SDCoins},tokenOverTime:function(){SDW_WEB._refreshUserData()},getSDWUserInfo:function(c){var a={};SDW_WEB.USER_INFO=SDW_WEB.USER_INFO||{};for(var b in SDW_WEB.USER_INFO)a[b]=SDW_WEB.USER_INFO[b];a.imei=SDW_WEB.guid;a.os=SDW_WEB.os;a.w=SDW_WEB.width;a.h=SDW_WEB.height;c.source.postMessage(JSON.stringify({postSdwData:!0,data:a,operate:"getSDWUserInfo_callback"}),"*")},openUrlToRoot:function(c,a){if(a.gid){var b=SDW_PATH.GAME_URL("play",a.gid);location.href=b}else location.href=a.url},exitFullScreen:function(){SDW_WEB.onShandw?SDW_WEB.sdw.exitFullScreen({success:function(){window._fullScreen=!1;setTimeout(function(){window.onresize&&window.onresize()},300)}}):SDW_WEB.onKD&&(SDW_WEB.onIOS?(callKDMSGToResponse(encodeURI(JSON.stringify({responseType:5}))),window._fullScreen=!1):(window._fullScreen=!1,kdjs&&kdjs.callOpenKDTopBar()),setTimeout(function(){window.onresize&&window.onresize()},300))},requestFullScreen:function(){SDW_WEB.onShandw?SDW_WEB.sdw.requestFullScreen({success:function(){window._fullScreen=!0;setTimeout(function(){window.onresize&&window.onresize()},300)}}):SDW_WEB.onKD&&(SDW_WEB.onIOS?(callKDMSGToResponse(encodeURI(JSON.stringify({responseType:4}))),window._fullScreen=!0):(window._fullScreen=!0,kdjs&&kdjs.callCloseKDTopBar()),setTimeout(function(){window.onresize&&window.onresize()},300))},sdw_postGameInfo:function(c,a){var b=a.data,d=+new Date,e="";if(SDW_WEB.MOBILE_GAME_GID==b.appid){b.sec=d;visitorMode.isVisitor||SDW_WEB.onMicroSDWAPP?(e=visitorMode._visitorToken||"",b.vst="1"):e=SDW_WEB.USER_INFO.otoken;b.sign=SDW_WEB.MD5(""+b.appid+b.channel+b.uid+b.sid+b.id+b.sname+b.nick+b.level+b.type+b.vip+b.power+b["new"]+e);d=SDW_WEB.MD5(""+b.channel+b.uid+d+e);b.token=d;if(d=SDW_WEB.getExtData())b.sdw_extdata=d;b=SDW_WEB.URLS.addParam(b,!0,"https://platform.shandw.com/pltupgi");SDW_WEB.getAjaxData(b,function(a){})}},requestHideQrcode:function(c){hidePayModelMask()},to_competition:function(c,a){location.href=a.link+"\x26v\x3d"+SDW_WEB.version},sdw_getLocalStorage:function(c,a){var b=SDW_WEB.Store.get(a.key,!0);c.source.postMessage(JSON.stringify({postSdwData:!0,data:b,oprate:"getLocalStorage_ok"}),"*")},sdw_setLocalStorage:function(c,a){SDW_WEB.Store.set(a.key,a.data,!0)},checkVisitorMode:function(c,a){visitorMode.isVisitor?(dialog.show("error","\u5145\u503c\u8bf7\u5148\u767b\u5f55",1),_myFuchuang&&_myFuchuang.fchiddenFn(0)):document.querySelector("#my-game-container").contentWindow.postMessage(JSON.stringify({postSdwData:!0,useweb:SDW_WEB.useweb,oprate:"choosePayCheckState_ok"}),"*")},onShowToolBar:function(c,a){SDW_WEB.sdw.onShowToolBar()},setSDWShareInfo:function(c,a){var b=a.shareInfo;b.title=b.title||SDW_WEB._sTitle||"\u95ea\u7535\u73a9\u6e38\u620f\u5e73\u53f0";b.desc=b.desc||SDW_WEB._sDes||"\u65e0\u9700\u4e0b\u8f7d\uff0c1\u79d2\u5f00\u6218\uff0c\u4e00\u8d77\u64b8\u602a\uff0c\u6211\u7b49\u4f60\uff01";b.imgUrl=b.imgUrl||SDW_WEB._sIcon||"https://www.shandw.com/app/tabicon/sdw.png";b.desc&&$(".sDesc").attr("content",b.desc);SDW_WEB.sdw.onSetShareOperate({share:b.share||!1,title:b.title,desc:b.desc,imgUrl:b.imgUrl,link:SDW_WEB.changeShareLinks(b.link),notSave:!0,success:function(){window.sdwShareState&&window.sdwShareState.successCallback&&window.sdwShareState.successCallback();c.source.postMessage(JSON.stringify({postSdwData:!0,oprate:"shareCallback_success"}),"*")},cancel:function(){window.sdwShareState&&window.sdwShareState.cancelCallback&&window.sdwShareState.cancelCallback();c.source.postMessage(JSON.stringify({postSdwData:!0,oprate:"shareCallback_cancel"}),"*")}})},sdw_logout:function(){SDW_WEB.sdw.logout()}},r=function(){var c={};return function(a,b){if(SDW_WEB.onKD||SDW_WEB.onShandw)c.name||(c.name=a.name,c.icon=a.icon,c.linkUrl=SDW_WEB.onIOS?SDW_WEB.URLS.addParam({gid:SDW_WEB.MOBILE_GAME_GID,channel:SDW_WEB.channel,myType:SDW_WEB.onKD?"kd":"sdw"},!0,SDW_PATH.MOBILE_ROOT+"gotoApp/"):location.href.split("#")[0]+"\x26v\x3d"+SDW_WEB.version+"\x26sdw_from\x3dsdw_desktop"),c.isSet="undefined"===typeof b?!0:!1,SDW_WEB.sdw.createDesktop({isSet:c.isSet,title:c.name,icon:c.icon,link:c.linkUrl,isFullScreen:!1,showMoreBtn:!0})}}();SDW_WEB.onShandw||(visitorMode.isVisitor=SDW_WEB.USER_INFO&&SDW_WEB.USER_INFO.uid?!1:!0);window.authGame=function(c){c=c||function(){};var a=SDW_WEB.queryParam,b=SDW_WEB.MOBILE_GAME_GID,d={gid:b},e=SDW_WEB.USER_INFO,f="m3g"==a.s_from;"undefined"!=typeof b?(d.uid=f?a.uid:e.uid,d.token=f?a.token:e.token,d.sec=f?a.sec:e.secheme,d.channel=f?a.channel:SDW_WEB.channel,a.gmUnitId&&(d.mthid=a.gmUnitId),a=SDW_WEB.URLS.addParam(d,!1,HTTP_AUTH),SDW_WEB.getAjaxData(a,function(a){if(1==a.result){SDW_WEB._sIcon=a.sIcon||a.icon;SDW_WEB._sTitle=a.sTit;SDW_WEB._sDes=a.sDes;if(SDW_WEB.onWyqq){var b=document.querySelector("#wy-game-icon");if(b){var d=new Image;d.src=SDW_WEB._sIcon;d.onload=function(){b.src=d.src};b.style.opacity="1"}window.top.postMessage(JSON.stringify({method:"WebviewNCGObject.setPageTitle",data:{title:a.name}}),"*")}SDW_WEB.setLoadText.setText("auth");SDW_WEB.gameName=a.name;if("undefined"!=typeof _gameShareData_){var e=_gameShareData_.shareInfo[Math.random()*_gameShareData_.shareInfo.length>>0];a.sTit=e[0];a.sDes=e[1]}n(a);r(a);e=["AppMessage","Timeline","QQ","QZone","Weibo"];SDW_WEB.onShandw&&SDW_WEB.sdw.onSetToolBarOperation(e.concat(["addDesktop","copyLink"]));SDW_WEB.sdw.onSetShareOperate({target:e,title:a.sTit,desc:a.sDes,link:SDW_WEB.changeShareLinks(),imgUrl:SDW_WEB._sIcon,success:function(){SDW_WEB.share_success_callback()},cancel:function(){}});p(a)}else-3==a.result?alert("-3"):alert(a.msg);c&&c(a)})):SDW_WEB.Log("\u7f3a\u5c11\u6e38\u620f\u53c2\u6570")}})();